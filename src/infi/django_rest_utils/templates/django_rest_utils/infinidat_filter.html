<h3>
    Advanced Filtering
    <button class="btn btn-default btn-sm" type="button" data-toggle="collapse" data-target="#filtering-collapse"><i class="glyphicon glyphicon-chevron-down"></i></button>
</h3>

<div class="collapse {% if active_filters %}in{% endif %}" id="filtering-collapse">

    <p>
    The syntax for filtering objects by specific fields is:
    </p>

    <p>
        <code>
        {{ url }}?&lt;field name&gt;=&lt;oper&gt;:&lt;value&gt;[&amp;&lt;field name&gt;=&lt;oper&gt;:&lt;value&gt;]*
        </code>
    </p>

    <p>The following fields can be used for filtering:</p>
    <form onsubmit="advanced_search(); return false;">
        <table class="table" style="width: auto;" id="advanced_filters">
            <tbody id="fields_table">

            </tbody>
            <tbody>
                <tr>
                     <td colspan="3">
                         <button type="submit" class="btn btn-success">Apply</button>
                    </td>
                    <td colspan="2">
                        <div style="float: right;">
                        <button  type="button" id="addMoreFilters" onclick="create_filter()" class="btn btn-primary">Add More Filters</button>
                        </div>
                    </td>

                </tr>
            </tbody>
        </table>
    </form>

    <p>
    These are the operators that can be used in filters:
    </p>

    <table class="table table-bordered">
        <tbody>
            <tr>
                <th>Operator</th>
                <th>Expects</th>
                <th>Description</th>
            </tr>
            {% for operator in operators %}
                <tr>
                    <td>{{ operator }}</td>
                    <td>{{ operator.get_expected_value_description }}</td>
                    <td>{{ operator.description }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <p>Notes:</p>
    <ul>
        <li>When filtering on more than one field, the conditions are ANDed together.</li>
        <li>String comparisons are case sensitive except for the <tt>like</tt> operator.</li>
        <li>Datetime values should be specified in ISO-8601 format: <tt>yyyy-mm-dd[Thh:mm[:ss][Z]]</tt>.
            <br>For example <tt>2014-01-17</tt> or <tt>2014-12-31T23:59:59Z</tt></li>
        <li>To filter on boolean fields use 1 for true and 0 for false.</li>
        <li>Lists of values should be comma-separated, and optionally enclosed in parentheses or square brackets.
            <br>For example <tt>red,blue,green</tt> or <tt>[red,blue,green]</tt></li>
    </ul>

</div>

<script>

    {% include "django_rest_utils/functions.js" %}

    function advanced_search(){
        var uri = window.location.toString();
        // remove all current filters in the uri
        fields_info.forEach(function(field){
            uri = removeQueryStringParameter(field.name, uri);
        });
        // add to the uri any filters that exists in the rows of the table advanced_filters
        $('#advanced_filters tr').each(function() {
            var selected_field = $(this).find('.select-field');
            var selected_operator =  $(this).find('.select-operator');
            var input_ = $(this).find(".input-value");
            if (selected_field.val() && input_.val()){
                var value = selected_operator.val() + ':' + encodeURIComponent(input_.val());
                uri = updateQueryStringParameter(selected_field.val(), value, uri);
            }
            else {
                uri = removeQueryStringParameter(selected_field.val(), uri);
            }
        });
        window.location = uri;
    }

    //GLOBAL ARRAYS TO BE USED IN THE FOLLOWING FUNCTIONS

    var fields_info = [
        {name: "", datatype: ""},
        {% for field in fields %}
            {name: "{{ field.name }}", datatype: "{{ field.datatype }}"},
        {% endfor %}
    ];

    var operators_info = [
        {% for operator in operators %}
            {name: "{{operator}}"},
        {% endfor %}
    ];


    var active_filters = [
        {% for filter in active_filters %}
            {name: "{{filter.0}}", value: "{{filter.1}}"},
        {% endfor %}
    ];


    var operator_allow_multiple = ['in','out'];

    window.addEventListener("load", function(event) {
        // if there is active filter, create filter from each active filter
        if (active_filters && active_filters.length){
            active_filters.forEach( function (item)
                {
                create_filter(item);
                }
            );
        }
        // if there is no active filter, create 3 new empty filters
        else {
             create_filter();
             create_filter();
             create_filter();
             }

        // ADD LISTENER TO ANY CHANGE IN THE TABLE IN SELECTOR OF FIELD
        // BUILDING A NEW INPUT TAG ACCORDING TO THE CURRENT FIELD AND SELECTED OPERATOR
        $('#fields_table').on('change', '.select-field', function(e){
           var target_ = $(e.target);
           var data_type = target_.find(':selected').attr('data-type');
           var parent_tr = $(e.target).closest('tr');
           parent_tr.find('.td-type').text('(' + data_type + ')');
           var input_tag = parent_tr.find('.input-value');

           //find the selected operator
           operator_tag = parent_tr.find('.select-operator');
           selected_operator = operator_tag.find(':selected').attr('value');

           new_input_tag = build_input_field(data_type, selected_operator);
           input_tag.replaceWith(new_input_tag);

        });

        // ADD LISTENER TO ANY CHANGE IN OPERATOR
        // CHANGE THE INPUT PATTERN ACCORDING TO THE CURRENT OPERATOR AND SELECTED FIELD
        $('#fields_table').on('change', '.select-operator', function(e){
            var target_ = $(e.target);
            var selected_operator = target_.find(':selected').attr('value');
            var parent_tr = $(e.target).closest('tr');
            var select_field_input= parent_tr.find('.select-field');
            var data_type = select_field_input.find(':selected').attr('data-type');

            input_pattern = build_input_pattern(data_type, selected_operator);
            pattern= input_pattern[0];
            title = input_pattern[1];
            if (pattern != ''){
                var input_tag = parent_tr.find('input');
                input_tag.attr('pattern', pattern).attr('title', title);
            }
        });

        $('#fields_table').on('click', '.remove-button', function(e){
            $(e.target).closest('tr').remove();

        });
    });


   function build_input_pattern(input_type, operator){
   //helper function to build the pattern attribute of the input field
        var pattern = ''
        var title = ''
        if (input_type == 'integer'){
            // if its integer and multiple values is allowed-> add a pattern to allow a list of integers
            if (operator_allow_multiple.includes(operator)){
                pattern =  '^\\[\\d+(,\\d+)*\\]|\\d+(,\\d+)*|\\(\\d+(,\\d+)*\\)$' //list: [0-9]+(,[0-9]+)*, between: '([0-9]+)*(,[0-9]+)'
                title = 'Integer list can contain only numbers seperated by a comma. It can be enclosed by () or []'
            }
            else if(operator == 'between'){
            // if is integer and operator between-> add a pattern to allow a comma separated pair of integers
                pattern = '(\\d+)*(,\\d+)'
                title = 'Operator Between can contain only two values separated by a comma'
            }
            // multiple values is not allowed-> add pattern to allow a single integer only
            else{
                pattern = '^\\d+$';
                title = 'Integer field can contain only numbers'
            }
        }
        else if (['double', 'float'].includes(input_type)){
           // if its double/float and multiple values is allowed-> add a pattern to allow a list of decimals
            if (operator_allow_multiple.includes(operator)){
                pattern = '^\\d+([.]\\d+)(,\\d+([.]\\d+))*|\\[\\d+([.]\\d+)(,\\d+([.]\\d+))*\\]|\\(\\d+([.]\\d+)(,\\d+([.]\\d+))*\\)$';
                title = 'A list of Decimal numbers can contain only decimal numbers seperated by a comma. It can be enclosed by () or []'
            }
            else if(operator == 'between') {
            // if is double/float and operator between-> add a pattern to allow a comma separated pair of decimals
                pattern = '^(\\d+([.]\\d+))*(,\\d+([.]\\d+))$'
                title = 'Operator Between can contain only two decimal values seperated by a comma'
            }
           // multiple values is not allowed-> add a pattern to allow a single float only
            else{
               pattern = '^\\d+([.]\\d+)$';
               title = 'A decimal number must contain a decimal point and number. i.e 1.0, 1.5'
            }
        }
        return [pattern, title];
   };


   function build_input_field(input_type, operator){
       if (input_type == 'boolean') {
            var input_field  = $("<select class='form-control input-value'><option value='1'>true</option><option value='0'>false</option</select>");
       }
       else {
            // if the input_type is not boolean, its type will be text and the content will be validated according to the
            // calculated pattern
           var input_field  = $("<input type='text' class='form-control input-value'></input>");
           // find out what should be the pattern and the title of the input field
           input_pattern = build_input_pattern(input_type, operator);
           pattern= input_pattern[0];
           title = input_pattern[1];
           if (pattern != ''){
                input_field.attr('pattern', pattern).attr('title', title);
           }
        };
       return input_field;
   };


    function create_filter(filter_){
        var tr_ = $('<tr/>');
        var td_field = $('<td/>');
        // create the select input of field
        var select_field = $('<select/>').attr('class', 'form-control select-field').appendTo(td_field);

        $(fields_info).each(function() {
            select_field.append($('<option>').attr('value',this.name).text(this.name).attr('data-type', this.datatype));
        });

        td_field.appendTo(tr_);

        var td_operator = $('<td/>');
        // create the select input of operator
        var div1 = $('<div/>').attr('class', 'form-inline');
        var div2 = $('<div/>').attr('class', 'form-group');

        var select_operator = $('<select/>').attr('class', 'form-control select-operator').appendTo(div2);

        $(operators_info).each(function() {
            select_operator.append($('<option>').attr('value',this.name).text(this.name));
        });

        var td_input = $('<td/>');

        div2.appendTo(div1);
        div1.appendTo(td_operator);
        td_operator.appendTo(tr_);
        td_input.appendTo(tr_);

        var td_type = $('<td/>').attr('style', 'vertical-align: middle;text-align: center;').attr('class', 'td-type').text('(' + 'unknown' + ')');
        td_type.appendTo(tr_);

        // if there is a given filter, assign its details in the filter inputs
        if (filter_ != undefined){
            $(select_field).val(filter_.name);
            // find the data type of the filter_ and insert it to the type column
            data_type = $(select_field).find(':selected').attr('data-type')
            td_type.text(data_type);
            var operator = filter_.value.substr(0,filter_.value.indexOf(':'));
            var value_ = filter_.value.substr(filter_.value.indexOf(':') + 1, filter_.value.length);
            if (operator == ''){
                operator = 'eq'
            }
            // create input tag according to the data type and the operator
            input_tag = build_input_field(data_type, operator)
            input_tag.appendTo(td_input);

            select_operator.val(operator);
            input_tag.val(value_);
         }
         else{
            // there is no active filter, make the input as readonly
            var input_tag = $('<input/>').attr('class', 'form-control input-value').attr('type', 'text');
            input_tag.attr('readonly', true).appendTo(td_input);
         }

        var td_remove = "<td style='vertical-align: middle;'><button type='button' class='btn-xs btn-danger  remove-button' title='remove this filter'>X</button></td>"

        $(td_remove).appendTo(tr_);

        $(tr_).appendTo('#fields_table');

    }


</script>
